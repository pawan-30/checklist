<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trip Checklist</title>
  <style>
    :root{
      --bg:#0b0f12; --panel:rgba(255,255,255,0.02); --text:#e6eef2; --muted:#9aa4ad;
      --accent:#0a84ff; --success:#32d74b; --glass-border:rgba(255,255,255,0.04);
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Inter, system-ui, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    html.light{ --bg:#fff; --panel:rgba(0,0,0,0.02); --text:#1d1d1f; --muted:#6b6b6f; color-scheme: light; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
      display:flex; align-items:flex-start; justify-content:center; padding:18px; font-size:15px;
    }

    .container{ width:100%; max-width:920px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:18px; padding:18px; box-shadow:0 10px 40px rgba(2,6,10,0.45); border:1px solid var(--glass-border); margin:8px;
    }

    header{display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap}
    .logo{width:44px; height:44px; border-radius:12px; display:grid; place-items:center;
      background:linear-gradient(135deg,#132427 0%, #102e25 100%); border:1px solid rgba(255,255,255,0.04);
    }
    h1{font-size:18px;margin:0}
    p.lead{margin:0;color:var(--muted); font-size:13px}

    .top-controls{margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .theme-switch{display:inline-flex; align-items:center; gap:8px; padding:6px; border-radius:999px; border:1px solid var(--glass-border)}
    .toggle{width:64px; height:34px; border-radius:999px; display:flex; align-items:center; padding:4px; cursor:pointer}
    .knob{width:26px; height:26px; border-radius:999px; background:var(--text); box-shadow:0 6px 14px rgba(2,6,10,0.35); transform:translateX(0); transition:transform .28s}
    html.light .knob{ transform:translateX(30px) }

    .btn{background:transparent;border:1px solid rgba(255,255,255,0.04); color:inherit;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700}
    .search-row{display:flex; gap:10px; margin-top:10px}
    .input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--glass-border); background:transparent;color:inherit; outline:none; min-width:0}
    .add-wrap{display:flex; gap:8px; align-items:center}
    .add-btn{padding:12px 14px; border-radius:12px; background:linear-gradient(90deg,var(--accent), #2a84ff); color:white; font-weight:700; border:none; cursor:pointer}

    .panel{margin-top:12px; background:var(--panel); padding:12px; border-radius:14px; min-height:180px}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{display:flex; gap:10px; align-items:center; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.02)}
    .handle{width:34px;height:34px;border-radius:8px; display:grid; place-items:center}
    .checkbox{width:20px;height:20px;border-radius:6px;border:1px solid rgba(255,255,255,0.06); display:grid; place-items:center; cursor:pointer}
    .checkbox.checked{background:linear-gradient(90deg,var(--success), #6be3b3); border:none}
    .text{flex:1; font-size:15px; min-width:0}
    .meta{font-size:12px;color:var(--muted)}
    .actions{display:flex; gap:6px}
    .icon-btn{background:transparent;border:0;color:var(--muted); cursor:pointer; padding:8px;border-radius:8px}

    .mobile-move{display:none}
    .move-btn{padding:8px 10px;border-radius:8px;border:1px solid var(--glass-border); background:transparent; font-weight:700}

    .footer{display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-top:12px; color:var(--muted); font-size:13px}

    @media (max-width:720px){
      body{padding:10px}
      .container{padding:14px}
      .logo{width:40px;height:40px}
      .search-row{flex-direction:column}
      .add-wrap{width:100%; flex-direction:row}
      .add-wrap .input{flex:1}
      .add-btn{width:120px}
      .handle{display:none}
      .mobile-move{display:flex; gap:6px}
    }
    @media (max-width:420px){
      .container{padding:12px;border-radius:12px}
      .add-wrap{flex-direction:column; gap:8px}
      .add-btn{width:100%}
      .theme-switch{display:none}
      h1{font-size:16px}
    }

    .empty{display:grid;place-items:center;padding:28px;border-radius:10px;border:1px dashed rgba(255,255,255,0.03); color:var(--muted)}
    input:focus, button:focus{outline:2px solid rgba(10,132,255,0.12); outline-offset:2px}
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="Trip checklist app">
    <header>
      <div class="logo" aria-hidden="true">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="6" width="20" height="12" rx="3" fill="#051a17" stroke="#0f352d"/>
          <path d="M7 9h10v6H7z" fill="#6be3b3" opacity="0.18"/>
          <circle cx="9" cy="12" r="1.6" fill="#6be3b3" />
        </svg>
      </div>

      <div style="flex:1;min-width:0">
        <h1>Trip Checklist</h1>
        <p class="lead">Smart, offline-first checklist for trips ‚Äî add, reorder, export.</p>
      </div>

      <div class="top-controls">
        <div class="theme-switch" title="Toggle theme">
          <div class="icon-sun">‚òÄÔ∏è</div>
          <div id="themeToggle" class="toggle" role="switch" aria-checked="false" tabindex="0">
            <div class="knob" id="knob"></div>
          </div>
          <div class="icon-moon">üåô</div>
        </div>

        <button id="exportBtn" class="btn" title="Export checklist">Export</button>
        <button id="clearBtn" class="btn" title="Clear completed">Clear Done</button>
      </div>
    </header>

    <div class="search-row">
      <input id="itemInput" class="input" placeholder="Add item(s) ‚Äî separate multiple with commas (e.g. 'jacket, socks, charger')" aria-label="New checklist item(s)" />
      <div class="add-wrap">
        <input id="noteInput" class="input" placeholder="Optional note (applies to all added items)" aria-label="Optional note" />
        <button id="addBtn" type="button" class="add-btn">Add</button>
      </div>
    </div>

    <section class="panel" aria-live="polite">
      <div id="list" class="list" aria-label="Checklist items"></div>
      <div id="empty" class="empty" style="display:none">Your trip checklist is empty ‚Äî add items to get started ‚úàÔ∏è</div>
    </section>

    <div class="footer">
      <div class="small" id="count">0 items</div>
      <div class="small">Tip: drag the handle to reorder on desktop ¬∑ use move buttons on mobile ¬∑ double-click to edit</div>
    </div>
  </div>

  <!-- optional SheetJS (xlsx). If blocked, fallback to CSV used -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    (function(){
      // guard: ensure DOM is ready; if script executes after DOM parse it's fine; otherwise wait
      function ready(fn){
        if(document.readyState === 'complete' || document.readyState === 'interactive') {
          setTimeout(fn, 0);
        } else {
          document.addEventListener('DOMContentLoaded', fn);
        }
      }

      ready(function(){
        // elements
        const htmlEl = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        const knob = document.getElementById('knob');
        const listEl = document.getElementById('list');
        const input = document.getElementById('itemInput');
        const noteInput = document.getElementById('noteInput');
        const addBtn = document.getElementById('addBtn');
        const empty = document.getElementById('empty');
        const count = document.getElementById('count');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');

        // theme
        const savedTheme = localStorage.getItem('trip.theme');
        const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        let theme = savedTheme || (systemDark ? 'dark' : 'light');
        function applyTheme(t){
          if(t === 'light'){ htmlEl.classList.add('light'); themeToggle.setAttribute('aria-checked','true') }
          else { htmlEl.classList.remove('light'); themeToggle.setAttribute('aria-checked','false') }
          localStorage.setItem('trip.theme', t);
        }
        applyTheme(theme);
        function animateKnob(){
          const toLight = htmlEl.classList.contains('light');
          knob.animate(
            [{ transform: toLight ? 'translateX(30px)' : 'translateX(0)' }],
            { duration: 300, fill: 'forwards', easing: 'cubic-bezier(.2,.9,.2,1)' }
          );
        }
        themeToggle.addEventListener('click', () => { theme = theme === 'light' ? 'dark' : 'light'; applyTheme(theme); animateKnob(); });
        themeToggle.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); theme = theme === 'light' ? 'dark' : 'light'; applyTheme(theme); animateKnob(); } });
        if(window.matchMedia) {
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if(!localStorage.getItem('trip.theme')) {
              const sys = e.matches ? 'dark' : 'light';
              theme = sys; applyTheme(theme); animateKnob();
            }
          });
        }

        // state
        const ID = () => '_' + Math.random().toString(36).slice(2,9);
        let items = [];
        try { items = JSON.parse(localStorage.getItem('trip.checklist.v1') || '[]') } catch(e){ items = [] }

        function save(){ try { localStorage.setItem('trip.checklist.v1', JSON.stringify(items)); } catch(_){} }

        // parse input into separate items
        function parseItemsFromText(text){
          if(!text) return [];
          // normalize separators, split, trim, filter
          const normalized = text.replace(/[\r\n]+/g, ',').replace(/[,;]+/g, ',');
          return normalized.split(',').map(s => s.trim()).filter(Boolean);
        }

        // add behavior ‚Äî defensive and idempotent
        function addItemsFromInput(e){
          if(e && e.preventDefault) e.preventDefault();
          const raw = (input.value || '').trim();
          const note = (noteInput.value || '').trim();
          const parsed = parseItemsFromText(raw);
          // nothing to add
          if(!parsed || parsed.length === 0){
            // small feedback
            try { input.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}], {duration:220}) } catch(_) {}
            return;
          }
          // create items and prepend
          const newItems = parsed.map(t => ({ id: ID(), text: t, note: note, done: false, important: false }));
          items = newItems.concat(items);
          save();
          render();
          // clear & focus
          input.value = '';
          noteInput.value = '';
          try { input.focus(); } catch(_) {}
        }

        // render UI
        function render(){
          listEl.innerHTML = '';
          if(!items || items.length === 0){
            empty.style.display = 'grid';
            count.textContent = '0 items';
            return;
          }
          empty.style.display = 'none';
          items.forEach((it, idx) => {
            const el = document.createElement('div'); el.className = 'item'; el.dataset.id = it.id; el.draggable = true;
            const handle = document.createElement('div'); handle.className = 'handle'; handle.innerHTML = '‚ò∞';
            const cb = document.createElement('div'); cb.className = 'checkbox' + (it.done ? ' checked' : ''); cb.setAttribute('role','button');
            cb.onclick = () => { it.done = !it.done; save(); render(); };
            cb.innerHTML = it.done ? '‚úì' : '';
            const text = document.createElement('div'); text.className = 'text' + (it.done ? ' done' : ''); text.textContent = it.text;
            text.title = 'Double-click to edit';
            text.ondblclick = () => editText(it, text);
            const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = it.note || '';
            const actions = document.createElement('div'); actions.className = 'actions';
            const star = document.createElement('button'); star.className = 'icon-btn'; star.innerHTML = it.important ? '‚òÖ' : '‚òÜ';
            star.onclick = () => { it.important = !it.important; save(); render(); };
            const del = document.createElement('button'); del.className = 'icon-btn'; del.innerHTML = 'üóë';
            del.onclick = () => { removeItem(it.id); };
            actions.appendChild(star); actions.appendChild(del);

            el.appendChild(handle);
            el.appendChild(cb);
            const mid = document.createElement('div'); mid.style.flex = '1';
            mid.appendChild(text);
            if(it.note) mid.appendChild(meta);
            el.appendChild(mid);

            const mobileMove = document.createElement('div'); mobileMove.className = 'mobile-move';
            const up = document.createElement('button'); up.className = 'move-btn'; up.textContent = '‚Üë';
            up.onclick = ()=> moveItem(idx, idx-1);
            const down = document.createElement('button'); down.className = 'move-btn'; down.textContent = '‚Üì';
            down.onclick = ()=> moveItem(idx, idx+1);
            mobileMove.appendChild(up); mobileMove.appendChild(down);
            el.appendChild(mobileMove);

            el.appendChild(actions);

            // drag behavior
            el.addEventListener('dragstart', (ev) => { el.classList.add('dragging'); try { ev.dataTransfer.setData('text/plain', it.id); } catch(_){}; setTimeout(()=>el.style.display='none',50); });
            el.addEventListener('dragend', () => { el.classList.remove('dragging'); el.style.display='flex'; render(); });

            listEl.appendChild(el);
          });

          // setup dragover/drop on items
          listEl.querySelectorAll('.item').forEach(node => {
            node.addEventListener('dragover', (e) => {
              e.preventDefault();
              const dragging = document.querySelector('.dragging');
              if(!dragging || dragging === node) return;
              const rect = node.getBoundingClientRect();
              const next = (e.clientY - rect.top) > rect.height/2;
              listEl.insertBefore(dragging, next ? node.nextSibling : node);
            });
            node.addEventListener('drop', (e) => {
              e.preventDefault();
              try { const id = e.dataTransfer.getData('text/plain'); finishReorder(id); } catch(_) {}
            });
          });

          count.textContent = items.length + ' items (' + items.filter(i => i.done).length + ' done)';
        }

        function moveItem(from, to){
          if(!Array.isArray(items) || items.length === 0) return;
          if(to < 0) to = 0;
          if(to >= items.length) to = items.length - 1;
          const arr = items.slice();
          const [item] = arr.splice(from, 1);
          arr.splice(to, 0, item);
          items = arr;
          save(); render();
        }

        function finishReorder(draggedId){
          const currentIds = Array.from(listEl.children).map(ch => ch.dataset.id);
          const newItems = [];
          currentIds.forEach(id => {
            const it = items.find(o => o.id === id);
            if(it) newItems.push(it);
          });
          items = newItems;
          save(); render();
        }

        function addItem(text, note){
          if(!text || !text.trim()) return;
          const item = { id: ID(), text: text.trim(), note: note ? note.trim() : '', done: false, important: false };
          items.unshift(item);
          save(); render();
        }

        function removeItem(id){
          items = items.filter(i => i.id !== id);
          save(); render();
        }

        function editText(it, el){
          const inputEl = document.createElement('input');
          inputEl.value = it.text;
          inputEl.className = 'input';
          el.replaceWith(inputEl);
          inputEl.focus(); inputEl.select();
          inputEl.onblur = () => { it.text = inputEl.value || it.text; save(); render(); };
          inputEl.onkeydown = (e) => { if(e.key === 'Enter') inputEl.blur(); if(e.key === 'Escape') render(); };
        }

        // export behavior (SheetJS fallback to CSV)
        function escapeCsv(str){
          if(typeof str !== 'string') return '""';
          if(str.includes(',') || str.includes('\n') || str.includes('"')) return '"' + str.replace(/"/g, '""') + '"';
          return '"' + str + '"';
        }
        exportBtn.addEventListener('click', function(){
          try {
            if(typeof XLSX !== 'undefined'){
              const rows = items.map(i => ({ Text: i.text, Note: i.note || '', Done: i.done ? 'Yes' : 'No', Important: i.important ? 'Yes' : 'No' }));
              const ws = XLSX.utils.json_to_sheet(rows);
              const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Checklist');
              const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
              const blob = new Blob([wbout], { type:'application/octet-stream' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a'); a.href = url; a.download = 'trip-checklist.xlsx'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
              return;
            }
          } catch(err) { console.warn('XLSX export failed, falling back to CSV', err) }
          const header = ['Text','Note','Done','Important'];
          const rows = items.map(i => [ escapeCsv(i.text), escapeCsv(i.note || ''), i.done ? 'Yes' : 'No', i.important ? 'Yes' : 'No' ]);
          const csv = [ header.join(','), ...rows.map(r => r.join(',')) ].join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'trip-checklist.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });

        clearBtn.addEventListener('click', function(){ items = items.filter(i => !i.done); save(); render(); });

        // wiring: button click, Enter key on inputs, paste handling
        addBtn.addEventListener('click', addItemsFromInput);
        input.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ addItemsFromInput(e); } });
        noteInput.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ addItemsFromInput(e); } });
        // paste: if user pastes multi-line text, parse and add
        input.addEventListener('paste', function(e){
          try {
            const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
            if(pasted && (pasted.includes('\n') || pasted.includes(','))){
              // allow paste then add in next tick to preserve paste value
              setTimeout(() => addItemsFromInput(), 30);
            }
          } catch(_) {}
        });

        // keyboard shortcuts
        window.addEventListener('keydown', function(e){
          if((e.ctrlKey || e.metaKey) && e.key === 'k'){ e.preventDefault(); input.focus(); }
          if(e.key === '/' && document.activeElement !== input){ e.preventDefault(); input.focus(); }
        });

        // initial render
        render();
      }); // ready
    })();
  </script>
</body>
</html>
